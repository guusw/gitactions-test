name: CI
on:
  push:
    branches:
      - "main"
    tags-ignore:
      - "auto-deps"
      - "auto-deps*"
  pull_request:
  workflow_dispatch:
jobs:
  pre-check:
    # This job only runs for pull request comments
    name: Test PR trigger
    runs-on: ubuntu-latest
    steps:
      - name: View context attributes
        uses: actions/github-script@v6
        with:
          script: |
            var run_ci = true;
            var against_branch = "devel";

            var pr = context.payload.pull_request;
            # console.log("Pull request", pr);
            if (pr != null) {
              let pr_body = pr.body;
              if(pr_body != null) {
                const regexp = /!(\w+)(=\w+)?/g;
                const tag_matches = [...pr_body.matchAll(regexp)];
                for (const match of tag_matches) {
                  console.log(`Found tag: ${match[1]} = ${match[2]}`);
                  if (match[1] == "noci") {
                    run_ci = false;
                    break;
                  } else if (match[1] == "against") {
                    against_branch = match[2];
                  }
                }
              }
            }
            console.log(context);
            return {
              run_ci: run_ci,
              against_branch: against_branch
            };
  build1:
    runs-on: ubuntu-latest
    depends-on: pre-check
    steps:
      - uses: actions/checkout@v2
      - name: Run script
        run: |
          echo "Running actions"